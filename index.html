<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MyDraftly — AI Writer</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="wrap">
    <h1>MyDraftly — AI Writer</h1>

    <div class="card">
      <div class="row">
        <div>
          <label>Topic</label>
          <input id="topic" placeholder="e.g., A simple content engine for solo creators">
        </div>
        <div>
          <label>Length</label>
          <select id="length">
            <option>short (300–500 words)</option>
            <option selected>medium (600–900 words)</option>
            <option>long (1000–1500 words)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div>
          <label>Tone</label>
          <select id="tone">
            <option selected>helpful and clear</option>
            <option>friendly and casual</option>
            <option>expert and concise</option>
            <option>energetic and motivating</option>
          </select>
        </div>
        <div>
          <label>Keywords (optional)</label>
          <input id="keywords" placeholder="notion, templates, automation">
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="go">Generate with AI</button>
        <span class="small" id="status"></span>
      </div>
    </div>

    <div id="result" class="card" style="display:none">
      <h2 id="title"></h2>
      <pre id="content"></pre>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="copy">Copy</button>
        <button class="btn" id="download">Download .md</button>
      </div>
      <div class="card" style="background:#0f0f12;border-color:#2a2a31">
        <h3>Publish to your blog</h3>
        <label>Title</label>
        <input id="pub_title">
        <label>Content (Markdown)</label>
        <textarea id="pub_content"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="publish">Publish</button>
        </div>
        <p class="small">This saves to Supabase. Then view it on <a href="/blog.html">/blog.html</a>.</p>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const status = $('status'), res = $('result'), titleEl = $('title'), contentEl = $('content');

    $('go').onclick = async () => {
      const topic = $('topic').value.trim();
      if(!topic){ status.textContent = "Enter a topic first"; return; }
      status.textContent = "Generating...";
      res.style.display = 'none';

      try{
        const body = {
          topic,
          tone: $('tone').value,
          length: $('length').value,
          keywords: $('keywords').value.trim()
        };
        const r = await fetch('/api/generate', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.error || 'Failed to generate');

        titleEl.textContent = data.title || 'Draft';
        contentEl.textContent = data.content || '';
        $('pub_title').value = titleEl.textContent;
        $('pub_content').value = contentEl.textContent;

        res.style.display = 'block';
        status.textContent = "Draft ready.";
      }catch(e){
        status.textContent = "Error: " + e.message + " (check OPENAI_API_KEY in Vercel)";
      }
    };

    $('copy').onclick = () => {
      navigator.clipboard.writeText(contentEl.textContent);
      status.textContent = "Copied.";
    };
    $('download').onclick = () => {
      const blob = new Blob([contentEl.textContent], {type:'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (titleEl.textContent || 'post') + '.md';
      a.click(); URL.revokeObjectURL(url);
    };

    $('publish').onclick = async () => {
      const title = $('pub_title').value.trim();
      const content = $('pub_content').value.trim();
      if(!title || !content){ alert('Title and content required'); return; }
      try{
        const r = await fetch('/api/publish', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ title, content })
        });
        const data = await r.json();
        if(!r.ok) throw new Error(data.error || 'Publish failed');
        alert('✅ Published! Opening blog…');
        location.href = '/blog.html';
      }catch(e){
        alert('Error: ' + e.message);
      }
    };
  </script>
</body>
</html>